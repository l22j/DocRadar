<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>채용 후기 크롤러 · 단일 HTML (기간 필터)</title>
  <style>
    :root{--bg:#0b0c10;--panel:#151720;--muted:#8f9bb3;--text:#e6e9ef;--accent:#6aa9ff;--accent2:#a78bfa;--ok:#22c55e;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Apple Color Emoji,Noto Color Emoji,emoji;font-size:14px;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(10,11,16,.95),rgba(10,11,16,.7));backdrop-filter:blur(10px);z-index:10;border-bottom:1px solid #222}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid #222;border-radius:16px;padding:14px}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{appearance:none;border:1px solid #2a2f3a;background:#1a1f2b;color:#e7ecf5;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.primary{background:linear-gradient(135deg,#3867ff,#a78bfa);border:none}
    .btn.ghost{background:transparent;border:1px dashed #3a3f4a}
    .tag{display:inline-flex;align-items:center;gap:6px;border:1px solid #333;border-radius:99px;padding:6px 10px;margin:4px 6px 0 0;color:#d7def0}
    input[type="text"], input[type="number"], input[type="date"], select, textarea{width:100%;background:#10131b;color:#e6e9ef;border:1px solid #2a2f3a;border-radius:10px;padding:10px}
    label{display:flex;align-items:center;gap:8px;color:#cfd7ea}
    small{color:var(--muted)}
    .cols{display:grid;grid-template-columns:360px 1fr;gap:14px}
    @media(max-width:980px){.cols{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #272b36;vertical-align:top}
    tbody tr:hover{background:#121624}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px}
    .pill.ok{background:#14351f;color:#7ee18a;border:1px solid #214b2c}
    .pill.bad{background:#39191b;color:#ff9999;border:1px solid #5a2a2e}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0f1220;border:1px solid #252a3a;border-radius:10px;padding:10px;white-space:pre-wrap}
    .footer-note{color:#98a2b3}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;border:1px solid #3a3f4a;border-bottom-width:3px;border-radius:6px;padding:0 6px;background:#0f1220}
    .progress{height:8px;background:#0e1322;border:1px solid #222;border-radius:99px;overflow:hidden}
    .progress>div{height:100%;width:0%;background:linear-gradient(90deg,#3867ff,#22d3ee,#34d399);transition:width .2s}
    .flex{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
    .warn{border-color:#3a2a1a;background:#17120b;color:#ffd7a8}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:50}
    .modal>.inner{background:#0f1322;border:1px solid #2b3244;border-radius:14px;max-width:720px;width:92%;padding:14px}
    .modal[hidden]{display:none}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0f1322;border:1px solid #2b3244;border-radius:10px;padding:10px 12px;color:#dfe7ff;z-index:60}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{border:1px solid #394154;background:#0f1322;border-radius:999px;padding:4px 8px;color:#dbe5ff;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="align-items:center">
      <div class="flex" style="gap:10px">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M4 4h16v12a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4V4z" stroke="#8fb1ff" stroke-width="1.4"/><path d="M8 8h8M8 12h5" stroke="#c3d1ff" stroke-width="1.4"/></svg>
        <strong>채용 후기 수집 · 분석 대시보드</strong>
      </div>
      <div class="right"><button class="btn ghost" id="btnHelp">도움말</button></div>
    </div>
  </header>

  <main class="wrap" style="margin-top:10px">
    <div class="cols">
      <section class="card">
        <h3>수집 설정</h3>
        <div class="grid">
          <div>
            <label>기업명<input id="company" type="text" value="넥슨" /></label>
          </div>
          <div>
            <label>키워드 (쉼표로 구분)
              <input id="keywords" type="text" value="상시채용 서류 합격, 상시채용 불합격, 서류 연락 언제, 서류 결과, 서탈, 서합" />
            </label>
          </div>
          <div>
            <label>검색 최대 결과/쿼리<input id="limit" type="number" min="1" max="50" value="10" /></label>
          </div>
          <div>
            <label>프록시(선택) <small>기본: Jina Reader(읽기 전용)</small>
              <input id="proxy" type="text" placeholder="예) https://your-cors-proxy.example/fetch?url=" />
            </label>
            <small>빈칸이면 <span class="kbd">https://r.jina.ai/http://&lt;URL&gt;</span>로 본문만 추출합니다. 일부 사이트는 차단될 수 있습니다.</small>
          </div>
        </div>

        <div class="grid" style="margin-top:8px">
          <div>
            <label>시작일 (YYYY-MM-DD)<input id="startDate" type="date" /></label>
          </div>
          <div>
            <label>종료일 (YYYY-MM-DD)<input id="endDate" type="date" /></label>
          </div>
          <div style="grid-column:1 / -1">
            <label class="tag"><input type="checkbox" id="includeNoDate" checked /> 날짜 미검출 문서 포함</label>
            <small>문서 본문에서 날짜를 찾지 못하면 제외될 수 있습니다. 포함 설정 시 필터를 우회합니다.</small>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>대상 커뮤니티</label>
          <div class="row">
            <label class="tag"><input type="checkbox" class="site" value="blind.co.kr" checked/> Blind</label>
            <label class="tag"><input type="checkbox" class="site" value="dcinside.com" checked/> 디시인사이드</label>
            <label class="tag"><input type="checkbox" class="site" value="gamejob.co.kr" checked/> 게임잡</label>
            <label class="tag"><input type="checkbox" class="site" value="linkareer.com" checked/> 링커리어</label>
            <label class="tag"><input type="checkbox" class="site" value="brunch.co.kr" checked/> 브런치</label>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="btnFetch" class="btn primary">① 수집</button>
          <button id="btnAnalyze" class="btn">② 정제/분석</button>
          <button id="btnDownloadJSON" class="btn">JSON 저장</button>
          <button id="btnDownloadCSV" class="btn">CSV 저장</button>
          <span class="right"><span id="status">대기 중</span></span>
        </div>
        <div class="progress" style="margin-top:10px"><div id="progressBar"></div></div>

        <details style="margin-top:12px">
          <summary>수동 URL 입력 (검색 실패 시 대안)</summary>
          <textarea id="manualUrls" rows="4" placeholder="https://example.com/post/1\nhttps://example.com/post/2"></textarea>
          <div style="margin-top:8px"><button class="btn" id="btnFetchManual">URL 본문 수집</button></div>
        </details>

        <details style="margin-top:12px" class="card warn">
          <summary><strong>주의·법적 고지 (중요)</strong></summary>
          <ul>
            <li>각 사이트의 <u>이용약관/robots.txt</u>를 준수하고, 과도한 요청을 피하세요(지연 요청 적용).</li>
            <li>개인정보나 민감정보를 저장/공유하지 마세요. 본 도구는 연구·학습용입니다.</li>
            <li>브라우저 기반 수집은 <u>CORS</u> 제약이 있어, 기본적으로 읽기 전용 프록시(<code>r.jina.ai</code>)를 사용합니다. 차단되면 사용자 소유 프록시를 설정하세요.</li>
          </ul>
        </details>
      </section>

      <section class="card">
        <h3>대시보드</h3>
        <div class="filters" id="activeFilters"></div>
        <div class="grid" style="margin-top:8px">
          <div class="card"><h3>합격자 대기일 분포</h3><canvas id="chartPass" height="160"></canvas></div>
          <div class="card"><h3>불합격자 대기일 분포</h3><canvas id="chartFail" height="160"></canvas></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div class="card">
            <h3>합격 통계</h3>
            <div id="statsPass" class="code">-</div>
          </div>
          <div class="card">
            <h3>불합격 통계</h3>
            <div id="statsFail" class="code">-</div>
          </div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:14px">
      <h3>수집 결과</h3>
      <div class="row" style="margin-bottom:8px">
        <label>필터 <input id="filter" type="text" placeholder="예: 합격, 불합격, 7일 등"></label>
        <button class="btn" id="btnCopyJSON">JSON 복사</button>
      </div>
      <div id="tableWrap" class="code" style="max-height:300px;overflow:auto">-</div>
    </section>

    <section class="card" style="margin-top:14px">
      <h3>의사 ‘/fetch’ (API 흉내) 응답</h3>
      <small>단일 파일이므로 실제 라우트는 없고, 아래에 JSON으로 표시합니다.</small>
      <pre id="apiFetch" class="code" style="max-height:240px;overflow:auto">[]</pre>
    </section>

    <section class="card" style="margin-top:14px">
      <h3>진단 / 자가 테스트</h3>
      <div class="row">
        <button id="btnRunTests" class="btn">기능 테스트 실행</button>
        <button id="btnTestClipboard" class="btn">클립보드 테스트</button>
      </div>
      <pre id="testOut" class="code" style="max-height:260px;overflow:auto">(아직 미실행)</pre>
    </section>

  </main>

  <footer class="wrap" style="margin:18px 0 40px" >
    <div class="footer-note">© 2025 채용 후기 크롤러 (단일 HTML). 개인 연구/학습용. 사이트 정책을 준수하세요.</div>
  </footer>

  <div id="copyModal" class="modal" hidden>
    <div class="inner">
      <h3 style="margin:0 0 8px">클립보드 권한이 차단되어 수동 복사가 필요합니다</h3>
      <p style="margin:6px 0 10px"><small>텍스트를 모두 선택(<span class="kbd">Ctrl/⌘+A</span>) 후 복사(<span class="kbd">Ctrl/⌘+C</span>)하세요.</small></p>
      <textarea id="copyArea" rows="10" style="width:100%;background:#0b0f1e;color:#e6e9ef;border:1px solid #2a2f3a;border-radius:10px;padding:10px"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="btnSelectAll" class="btn">전체 선택</button>
        <button id="btnCloseModal" class="btn ghost right">닫기</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" hidden></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script>
    const sleep = (ms)=> new Promise(res=> setTimeout(res, ms));
    const byId = (id)=> document.getElementById(id);
    function showToast(msg, ms=2200){ const t = byId('toast'); t.textContent = msg; t.hidden = false; clearTimeout(showToast._tid); showToast._tid = setTimeout(()=> t.hidden = true, ms); }

    // ---- Parsing helpers ----
    function extractWaitDays(text){
      let days = [];
      if(!text) return days;
      const t = text.replace(/\s+/g,' ');
      const ctx = /([0-9]+(?:\.[0-9]+)?)\s*(일|날|주|주일|주간|개월|달)\s*(?:뒤|후)?\s*(?:연락|결과|통보|합격|불합격)?/g;
      let m; while((m = ctx.exec(t))){
        let v = parseFloat(m[1]); let u = m[2]; let d = 0;
        if(/일|날/.test(u)) d = v; else if(/주/.test(u)) d = v*7; else if(/개월|달/.test(u)) d = v*30;
        if(d>0 && d<365) days.push(d);
      }
      return days;
    }
    function labelFromText(text){
      const s = (text||'').toLowerCase();
      const pos = /(합격|서합|최종 합격|통과|붙었|붙음|offer)/i;
      const neg = /(불합격|서탈|광탈|탈락|미통과|거절|reject)/i;
      if(pos.test(s) && !neg.test(s)) return '합격';
      if(neg.test(s) && !pos.test(s)) return '불합격';
      return '미정';
    }
    function extractDate(text){
      if(!text) return null;
      const ymd = /(20\d{2})[.\-\/ ]?(\d{1,2})[.\-\/ ]?(\d{1,2})/;
      const kor = /(20\d{2})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일/;
      let m = text.match(kor) || text.match(ymd);
      if(m){ const y=+m[1], mo=+m[2], d=+m[3]; if(mo>=1&&mo<=12&&d>=1&&d<=31){ const dt = new Date(y, mo-1, d); return dt.toISOString().slice(0,10); } }
      return null;
    }
    function quantiles(arr){ if(!arr.length) return {min:null,max:null,mean:null,median:null}; const a=[...arr].sort((x,y)=>x-y); const mean=a.reduce((p,c)=>p+c,0)/a.length; const mid=Math.floor(a.length/2); const median=a.length%2? a[mid] : (a[mid-1]+a[mid])/2; return {min:a[0],max:a[a.length-1],mean,median}; }
    function toCSV(rows){ if(!rows.length) return ''; const keys=Object.keys(rows[0]); const esc=v=>'"'+String(v??'').replace(/"/g,'""')+'"'; const header=keys.map(esc).join(','); const lines=rows.map(r=>keys.map(k=>esc(r[k])).join(',')); return [header,...lines].join('\n'); }

    // ---- Clipboard helpers with fallbacks ----
    async function copyToClipboard(text){
      try{ if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); return {ok:true,method:'clipboard'}; } }catch(e){}
      try{ const ta=document.createElement('textarea'); ta.value=text; ta.setAttribute('readonly',''); ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); const ok=document.execCommand('copy'); document.body.removeChild(ta); if(ok) return {ok:true,method:'execCommand'}; }catch(e){}
      try{ const modal=byId('copyModal'); const area=byId('copyArea'); area.value=text; modal.hidden=false; setTimeout(()=>{area.focus();area.select();},50); }catch(e){}
      return {ok:false,method:'manual'};
    }
    function download(filename, text){ const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000); }

    // ---- Fetch/search helpers ----
    async function fetchTextViaProxy(url, proxyPrefix){
      try{
        let target=url;
        if(proxyPrefix && proxyPrefix.trim()) target=proxyPrefix + encodeURIComponent(url);
        else target='https://r.jina.ai/http/' + url.replace(/^https?:\/\//,'');
        const r=await fetch(target,{headers:{'User-Agent':'Mozilla/5.0 Fetch'}});
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.text();
      }catch(e){ console.warn('fetch fail',url,e); return ''; }
    }
    function extractUrlsFromSearchText(txt, allowedDomains){
      const urls=new Set(); const re=/(https?:\/\/[^\s\)\]\}]+?)(?=[\s\)\]\}"\'<>]|$)/g; let m; while((m=re.exec(txt))){ try{ const u=new URL(m[1]); if(allowedDomains.some(d=>u.hostname.includes(d))){ if(!/duckduckgo\.com/.test(u.hostname)) urls.add(u.toString()); } }catch{} } return [...urls]; }

    async function searchSiteQueries({company, keywords, domains, limit, proxy}){
      const queries=[]; for(const kw of keywords){ for(const dom of domains){ const q=`site:${dom} ${company} ${kw}`; const searchUrl='https://duckduckgo.com/html/?kl=kr-ko&q='+encodeURIComponent(q); queries.push({dom,q,searchUrl}); }}
      const results=[]; let done=0; const total=queries.length;
      for(const item of queries){ byId('status').textContent=`검색중: ${item.q}`; byId('progressBar').style.width=Math.round((++done/total)*100)+'%'; const txt=await fetchTextViaProxy(item.searchUrl, proxy); const urls=extractUrlsFromSearchText(txt,[item.dom]).slice(0,limit); for(const u of urls){ results.push({source:item.dom,url:u}); } await sleep(600); }
      return results;
    }

    async function pullPages(pages, proxy){
      const out=[]; let i=0; for(const p of pages){ byId('status').textContent=`본문 수집중 (${++i}/${pages.length})`; const txt=await fetchTextViaProxy(p.url, proxy); const title=(txt.match(/\n\s*(.+)\n/)||[])[1]||''; const date=extractDate(txt); const waits=extractWaitDays(txt); const label=labelFromText(txt); out.push({source:p.source,url:p.url,title:title?.slice(0,120)||'',date,label,waits,raw_len:txt.length}); await sleep(500);} return out;
    }

    // ---- Date range filter ----
    function inDateRange(iso, startIso, endIso){
      if(!iso) return false; // unknown date treated as out (can be overridden by includeNoDate)
      const d=new Date(iso+ (iso.length===10?'T00:00:00Z':''));
      if(isNaN(d)) return false;
      if(startIso){ const s=new Date(startIso+'T00:00:00Z'); if(d < s) return false; }
      if(endIso){ const e=new Date(endIso+'T23:59:59Z'); if(d > e) return false; }
      return true;
    }
    function applyDateFilter(rows){
      const start=byId('startDate').value; const end=byId('endDate').value; const includeNo=byId('includeNoDate').checked;
      const filtered = rows.filter(r=>{
        if(r.date && inDateRange(r.date,start,end)) return true;
        if(!r.date) return includeNo;
        return false;
      });
      // Render active chips
      const chips=[]; if(start) chips.push(`시작일: ${start}`); if(end) chips.push(`종료일: ${end}`); chips.push(`날짜 미검출 포함: ${includeNo?'예':'아니오'}`); byId('activeFilters').innerHTML = chips.map(c=>`<span class="chip">${c}</span>`).join('');
      return filtered;
    }

    // ---- Render/analysis ----
    function renderTable(rows){ if(!rows.length){ byId('tableWrap').textContent='-'; return;} const head=['source','date','label','waits','title','url']; const html=[`<table><thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`]; for(const r of rows){ const waits=r.waits?.length?r.waits.map(v=>v.toFixed(1)).join('/') : ''; html.push(`<tr>\n<td>${r.source}</td>\n<td>${r.date||''}</td>\n<td>${r.label==='합격'?`<span class='pill ok'>합격</span>`: r.label==='불합격'?`<span class='pill bad'>불합격</span>`:'-'}</td>\n<td>${waits}</td>\n<td>${(r.title||'').replace(/[<>]/g,c=>({"<":"&lt;",">":"&gt;"}[c]))}</td>\n<td><a href="${r.url}" target="_blank">열기</a></td>\n</tr>`);} html.push('</tbody></table>'); byId('tableWrap').innerHTML=html.join(''); }
    function calcStats(rows, which){ const arr=[]; for(const r of rows){ if(r.label===which && Array.isArray(r.waits)) arr.push(...r.waits);} const q=quantiles(arr); return {count:arr.length,...q}; }
    function fmt(n){ return n==null?'-': (Math.round(n*10)/10).toFixed(1)+'일'; }
    function renderStats(){ const pass=calcStats(state.filtered,'합격'); const fail=calcStats(state.filtered,'불합격'); byId('statsPass').textContent=`표본: ${pass.count}\n평균: ${fmt(pass.mean)}\n중앙값: ${fmt(pass.median)}\n최솟값: ${fmt(pass.min)}\n최댓값: ${fmt(pass.max)}`; byId('statsFail').textContent=`표본: ${fail.count}\n평균: ${fmt(fail.mean)}\n중앙값: ${fmt(fail.median)}\n최솟값: ${fmt(fail.min)}\n최댓값: ${fmt(fail.max)}`; }
    function buildHistogramData(rows, which){ const vals=[]; for(const r of rows){ if(r.label===which) vals.push(...(r.waits||[])); } const buckets=new Map(); for(const v of vals){ const k=Math.max(0,Math.floor(v)); buckets.set(k,(buckets.get(k)||0)+1);} const labels=[...buckets.keys()].sort((a,b)=>a-b).slice(0,90); return {labels:labels.map(n=>n+"일"), data:labels.map(k=>buckets.get(k)||0)}; }
    let chartPass=null, chartFail=null; function renderCharts(){ const p=buildHistogramData(state.filtered,'합격'); const f=buildHistogramData(state.filtered,'불합격'); const make=(ctx,dat,label)=> new Chart(ctx,{type:'bar', data:{labels:dat.labels,datasets:[{label,data:dat.data}]}, options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{color:'#1f2432'}}}}}); chartPass?.destroy(); chartFail?.destroy(); chartPass=make(byId('chartPass'),p,'합격 대기일'); chartFail=make(byId('chartFail'),f,'불합격 대기일'); }

    // ---- State ----
    const state = { rows: [], filtered: [] };
    function applyAll(){ state.filtered = applyDateFilter(state.rows); const q=byId('filter').value.trim(); let toShow = state.filtered; if(q){ const re=new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i'); toShow = toShow.filter(r=> re.test(JSON.stringify(r))); } renderTable(toShow); renderStats(); renderCharts(); byId('apiFetch').textContent=JSON.stringify(state.rows,null,2); }

    // ---- Events ----
    async function runFetchFlow(pages, proxy){ const rows = await pullPages(pages, proxy); state.rows = rows; applyAll(); byId('status').textContent = `완료: 총 ${rows.length}건 (필터 후 ${state.filtered.length}건)`; }

    byId('btnFetch').addEventListener('click', async ()=>{
      try{ byId('btnFetch').disabled=true; byId('status').textContent='검색 시작'; const company=byId('company').value.trim(); const keywords=byId('keywords').value.split(',').map(s=>s.trim()).filter(Boolean); const limit=+byId('limit').value || 10; const proxy=byId('proxy').value.trim(); const domains=[...document.querySelectorAll('.site:checked')].map(el=>el.value); const pages=await searchSiteQueries({company,keywords,domains,limit,proxy}); await runFetchFlow(pages, proxy); }catch(e){ console.error(e); alert('수집 중 오류: '+e.message);} finally{ byId('btnFetch').disabled=false; byId('progressBar').style.width='0%'; }
    });

    byId('btnFetchManual').addEventListener('click', async ()=>{ const proxy=byId('proxy').value.trim(); const lines=byId('manualUrls').value.split(/\n+/).map(s=>s.trim()).filter(Boolean); const pages=lines.map(u=>({source:new URL(u).hostname, url:u})); await runFetchFlow(pages, proxy); });

    byId('btnAnalyze').addEventListener('click', ()=>{ applyAll(); byId('status').textContent='분석 갱신됨'; });
    byId('btnDownloadJSON').addEventListener('click', ()=> download('fetch_result.json', JSON.stringify(state.filtered.length? state.filtered:state.rows, null, 2)) );
    byId('btnDownloadCSV').addEventListener('click', ()=> download('fetch_result.csv', toCSV(state.filtered.length? state.filtered:state.rows)) );
    byId('btnCopyJSON').addEventListener('click', async ()=>{ const txt=JSON.stringify(state.filtered.length? state.filtered:state.rows, null, 2); const res=await copyToClipboard(txt); showToast(res.ok?`JSON 복사됨 (${res.method})`:'클립보드 차단 → 수동 복사창 표시'); });

    ['filter','startDate','endDate'].forEach(id=> byId(id).addEventListener('input', applyAll));
    byId('includeNoDate').addEventListener('change', applyAll);

    byId('btnHelp').addEventListener('click', ()=>{ alert(`사용 방법\n\n1) 기업·키워드·기간(시작일/종료일)을 설정하고 [① 수집]을 누르세요.\n   - 본문에서 날짜를 파싱해 기간 필터를 적용합니다.\n   - '날짜 미검출 문서 포함'을 끄면 기간이 없는 문서는 제외됩니다.\n2) [② 정제/분석]으로 통계와 히스토그램을 갱신합니다.\n3) 결과는 표/JSON/CSV로 저장할 수 있습니다.`); });

    byId('btnSelectAll').addEventListener('click', ()=>{ const a=byId('copyArea'); a.focus(); a.select(); showToast('전체 선택됨. Ctrl/⌘+C 로 복사'); });
    byId('btnCloseModal').addEventListener('click', ()=> byId('copyModal').hidden=true);

    // ---- Tests (existing + new) ----
    function assertEq(name, a, b){ const ok=(JSON.stringify(a)===JSON.stringify(b)); return `${ok?'✅':'❌'} ${name}: ${ok? 'ok' : `expected ${JSON.stringify(b)} got ${JSON.stringify(a)}`}`; }
    async function runTests(){
      const out=[];
      out.push(assertEq('extractWaitDays 3일 후', extractWaitDays('서류 3일 후 연락 옴'), [3]));
      out.push(assertEq('extractWaitDays 2주 뒤', extractWaitDays('2주 뒤 결과 발표'), [14]));
      out.push(assertEq('extractWaitDays 1.5개월 후', extractWaitDays('1.5개월 후 통보'), [45]));
      out.push(assertEq('label 합격', labelFromText('서류 합격 연락'), '합격'));
      out.push(assertEq('label 불합격', labelFromText('서탈했습니다'), '불합격'));
      out.push(assertEq('label 혼재 → 미정', labelFromText('합격인줄 알았는데 불합격이었음'), '미정'));
      out.push(assertEq('extractDate 한글', extractDate('2024년 7월 3일 서류 결과'), '2024-07-03'));
      out.push(assertEq('extractDate ISO', extractDate('서류는 2025-08-29 발표'), '2025-08-29'));
      const q=quantiles([1,2,3,4]); out.push(assertEq('quantiles mean', q.mean, 2.5)); out.push(assertEq('quantiles median', q.median, 2.5)); out.push(assertEq('quantiles min', q.min, 1)); out.push(assertEq('quantiles max', q.max, 4));
      const csv=toCSV([{a:1,b:'x'},{a:2,b:'y'}]).split('\n'); out.push(assertEq('toCSV header', csv[0], '"a","b"')); out.push(assertEq('toCSV r1', csv[1], '"1","x"')); out.push(assertEq('toCSV r2', csv[2], '"2","y"'));
      // New: inDateRange & applyDateFilter
      out.push(assertEq('inDateRange inside', (function(){return inDateRange('2025-08-15','2025-08-01','2025-08-31');})(), true));
      out.push(assertEq('inDateRange before', (function(){return inDateRange('2025-07-31','2025-08-01','2025-08-31');})(), false));
      out.push(assertEq('inDateRange after', (function(){return inDateRange('2025-09-01','2025-08-01','2025-08-31');})(), false));
      const sampleRows=[{date:'2025-08-10'},{date:'2025-08-20'},{date:null}];
      byId('startDate').value='2025-08-01'; byId('endDate').value='2025-08-31'; byId('includeNoDate').checked=false; const f1=applyDateFilter(sampleRows); out.push(assertEq('applyDateFilter exclude no-date', f1.length, 2));
      byId('includeNoDate').checked=true; const f2=applyDateFilter(sampleRows); out.push(assertEq('applyDateFilter include no-date', f2.length, 3));

      try{ const res=await copyToClipboard('테스트 복사 문자열'); out.push(`✅ copyToClipboard returned: ${JSON.stringify(res)}`); }catch(e){ out.push(`❌ copyToClipboard threw: ${e}`); }
      byId('testOut').textContent=out.join('\n');
    }
    byId('btnRunTests').addEventListener('click', runTests);
    byId('btnTestClipboard').addEventListener('click', async ()=>{ const res=await copyToClipboard('clipboard-permission-test'); showToast(res.ok?`복사 성공 (${res.method})`:'권한 차단으로 수동 복사창 표시'); });

    (function init(){ byId('tableWrap').textContent='-'; byId('statsPass').textContent='-'; byId('statsFail').textContent='-';})();
  </script>
</body>
</html>
